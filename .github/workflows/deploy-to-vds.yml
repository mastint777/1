name: Deploy to VDS

on:
  push:
    branches: [main]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: SSH to server and deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VDS_HOST }}
          username: ${{ secrets.VDS_USER }}
          password: ${{ secrets.VDS_PASSWORD }}
          port: ${{ secrets.VDS_PORT || 22 }}
          script_stop: true
          script: |
            set -e

            echo "=== Starting deployment process ==="
            echo "Timestamp: $(date)"
            echo "User: $(whoami)"
            echo "Working directory: $(pwd)"

            # Clone or pull repository
            if [ ! -d /opt/1 ]; then
              echo "Cloning repository..."
              mkdir -p /opt
              cd /opt
              git clone https://github.com/mastint777/1.git
            else
              echo "Updating repository..."
              cd /opt/1
              git pull origin main
            fi

            cd /opt/1
            echo "Current git branch: $(git branch --show-current)"
            echo "Latest commit: $(git log -1 --oneline)"

            # ---- Backend Setup ----
            echo ""
            echo "=== Setting up backend ==="
            cd /opt/1/backend

            # Check if Python 3 is available
            if ! command -v python3 &> /dev/null; then
              echo "ERROR: python3 not found. Please install Python 3."
              exit 1
            fi
            echo "Python version: $(python3 --version)"

            # Create virtual environment if it doesn't exist
            if [ ! -d venv ]; then
              echo "Creating virtual environment..."
              python3 -m venv venv
            else
              echo "Virtual environment already exists"
            fi

            # Activate virtual environment and install dependencies
            echo "Installing backend dependencies..."
            . venv/bin/activate
            pip install --upgrade pip --quiet
            pip install -r requirements.txt --quiet
            deactivate
            echo "✓ Backend dependencies installed"

            # Install backend systemd service
            echo "Installing backend systemd service..."
            sudo cp /opt/1/deployment/backend.service /etc/systemd/system/backend.service
            sudo systemctl daemon-reload
            sudo systemctl enable backend.service
            echo "✓ Backend service installed"

            # ---- Frontend Setup ----
            echo ""
            echo "=== Setting up frontend ==="
            cd /opt/1/frontend

            # Check if Node.js is available
            if ! command -v node &> /dev/null; then
              echo "ERROR: node not found. Please install Node.js."
              exit 1
            fi
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"

            # Install Node.js dependencies and build
            echo "Installing frontend dependencies..."
            npm install --quiet
            echo "Building frontend..."
            npm run build
            echo "✓ Frontend built successfully"

            # Install frontend systemd service
            echo "Installing frontend systemd service..."
            sudo cp /opt/1/deployment/frontend.service /etc/systemd/system/frontend.service
            sudo systemctl daemon-reload
            sudo systemctl enable frontend.service
            echo "✓ Frontend service installed"

            # ---- Restart Services ----
            echo ""
            echo "=== Restarting services ==="
            sudo systemctl restart backend.service
            echo "Backend service restarted"
            sudo systemctl restart frontend.service
            echo "Frontend service restarted"

            # ---- Verify Services ----
            echo ""
            echo "=== Verifying services ==="
            sleep 5

            # Check backend
            if sudo systemctl is-active --quiet backend.service; then
              echo "✓ Backend is running"
              sudo systemctl status backend.service --no-pager -l | head -20
            else
              echo "✗ Backend failed to start"
              echo "Backend logs:"
              sudo journalctl -u backend.service -n 50 --no-pager
              exit 1
            fi

            echo ""

            # Check frontend
            if sudo systemctl is-active --quiet frontend.service; then
              echo "✓ Frontend is running"
              sudo systemctl status frontend.service --no-pager -l | head -20
            else
              echo "✗ Frontend failed to start"
              echo "Frontend logs:"
              sudo journalctl -u frontend.service -n 50 --no-pager
              exit 1
            fi

            echo ""
            echo "=== Deployment completed successfully! ==="
            echo "Timestamp: $(date)"
